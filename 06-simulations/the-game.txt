 1. Why simulations?
 2. Simulating the CLT
 3. Normal plots

 ***

  Често бихме желали да симулираме разни работи с R. Днес ще се научим да
  правим точно това.

  Първата задачка, която ще разгледаме е свързана с тежкия въпрос каква е
  вероятността в стая с `n` човека да има двама с рожден ден на една и съща
  дата. Да симулираме решението на тая задача значи да създадем голям брой
  случайни съвкупности от хора и да видим в колко от тях се е случило това
  събитие. Понеже нямаме практическата възможност да се сдобием с много стаи и
  много хора, ще се наложи да си генерираме данните в R. Как ще стане това?
  Ами, най-простият начин е да използваме функцията `sample`. Тя взима някакъв
  вектор от данни и от него ни изважда случайни елементи. Например,
    
    > birthdays = sample(seq(1, 365), 100, replace=T)

  ще ни извади 100 дни от 365, като ще ни позволи да имаме повтарящи се дни.
  Това много приятно симулира ситуацията, в която имаме 100 човека в стая и
  питаме всеки на коя дата е роден.

  Следващото нещо, което ни трябва е да разберем във всяка такава случайна
  извадка, колко дублиращи дни е имало. Това ще стане с функцията
  `duplicates`. Тази функция, имайки за параметър вектор, връща индексите на
  елементите в този вектор, за които има дублиращи се елементи. Това ще рече,
  че следният израз

    > birthdays[duplicates(birthdays)]

  ще ни даде вектор състоящ се само от дублираните рождени дни. Ако този
  вектор е с дължина 0, значи в текущата случайна извадка не е имало двойка
  хора с повтарящи се рождени дни.

  Всичко е много хубаво обаче това беше само един наш опит. За да направим
  качествена симулация трябва да направим много експерименти и да запишем броя
  на успешните експерименти. За целта, ще врътнем един цикъл за всяка
  итерация, на който, ще правим експеримент и ще го броим ако е успешен.

    > duplicateBDays = 0
    > numSims = 1000
    >
    > for (i in seq(1, numSims)) {
    >   birthdays = sample(seq(1, 365), 100, replace=T)
    >   dups = birthdays[duplicates(birthdays)]
    >
    >   if (length(dups) > 0) {
    >     duplicateBDays = duplicateBDays + 1
    >   }
    > }

  Единственото, което ни остава да направим, е да разделим броя на дублиращите
  се рождени дни на общия брой експерименти.

    > prob = duplicateBDays / numSims

TODO: Add simulation about phone calls
 
  Продължаваме с централната гранична теорема (Central Limit Theorem). Тя
  гласи, че при определени условия, сумата и средното аритметично на голям
  брой независими случайни величини ще бъде приблизително нормално
  разпределено, независимо от разпределението на тези случайни величини.
  Естествено, тези случайни величини трябва да имат дефинирано математическо 
  очакване и стандартно отклонение.

  Математически изразено, ако имаме наблюденията Xi взети от популация със
  знайни математическо очакване (mu) и стандартно отклонение (sd), то
  стандартизираното средно:

                           mean(X) - mu
                          --------------
                           sd / sqrt(n)

  E приблизително нормално разпределено със средно mu и стандартно отклонение
  sd.

  Първият въпрос, на който трябва да си отговорим е - Какво представлява
  нормалното разпределение? Ами, то е непрекъснато разпределение, което е
  характерно за голям набор от случайни събития. Формата му е камбановидна и
  симетрична относно математическото очакване.

  Каква е ползата от централна гранична теорема (ЦГТ)? Често ни се налага да
  правим статистически заключения за дадена популация на базата на извадка от
  тази популация. За да си направим тези статистически изводи, ние изчисляваме
  определени функции наречени оценки на извадката. Тези оценки често са суми
  или средни на извадката. Понеже знаем, че, за достатъчно голям брой
  измервания, техните суми или средни са приблизително нормални, то ние можем
  да опишем поведението на тези оценки чрез нормално разпределение и да си
  правим изводи за това колко е вероятно да наблюдаваме някои техни стойности.

  Сега ще видим как можем да симулираме разпределението на резултатите
  получени от ЦГТ.

  Първата симулация, която ще направим, е свързана с биномно разпределение.
  Имаме n биномно разпределени случайни величини и искаме да апроксимираме
  сумата им чрез нормално разпределение. Ако S е биномна разпределена,
  нейното математическо очакване mu е равно на n*p, а стандартното ѝ
  отклонение sd е равно на n*p*q. Тогава, от по-горната формула следва, че
  случайната величина, която апроксимира математическото очакване на тези
  случайни величини, е нормално разпределена и се изчислява чрез следната
  формула:

                               S - n*p
                          -----------------
                           sqrt(n*p*(1-p))

  Нека симулираме това в R за S - биномно разпределена случайна величина
  с n=10 и p=0.25:

    > n=10; p=0.25
    > S = rbinom(1000, n, p) # Генерираме 1000 независими, биномно
    + разпределени случайни величини
    > X = (S - n*p) / sqrt(n*p*(1-p))

  Единственото, което ни остава е да нарисуваме разпределението им за да видим
  доколко то прилича на нормално разпределение:
  
    > hist(X, prob=T, col="cadetblue3")
    > curve(dnorm(x), add=T)

  Виждаме, че получената хистограма доста се приближава до теоретичната
  плътност на нормалното разпределение.

  Ще покажем как ЦГТ ни помага да направим заключение за дадена извадка. Имаме
  следния проблем - знаем, че продължителността на болестта на Алцхаймер от 
  първите симптоми до смъртта е от 3 до 20 години; със средно 8 години и
  стандартно отклонение 4 години. Управител на голяма болница избира на
  случаен принцип медицинските картони на 30 починали от Алцхаймер пациенти.
  Той се пита каква е вероятността, че средната продължителност на живота на
  пациент болен от Алцхаймер ще бъде по-малка от 7 години.

  В тази задача знаем, че средната продължителност на живота на пациент болен
  от Алцхаймер е 8 години със стандартно отклонение 4 години. Това е валидно
  за цялата популация. Имайки тази информация, искаме да си направим
  заключение за извадка от тази популация - 30-те починали пациенти в
  болницата.

  Когато използваме централна гранична теорема за приближение на средно на
  дадена популация, трябва да се запитаме колко близки до нормалното
  разпределение са нашите данни. В случая виждаме, че данните са килнати
  наляво - голям брой пациенти живеят малко на брой години след настъпването
  на болестта. Следователно ще ни трябват повече хора за да е вярно
  заключението ни. В случая имаме 30 пациента - това е достатъчно количество.
  Ако данните ни бяха нормално разпределени, или симетрични около средното,
  щяха да ни трябват много по-малко количество пациенти.

  Вторият въпрос, на който трябва да си отговорим преди да решим задачата, е
  до колко нашите заключения се отнасят до голямо количество от болници в
  страната. Тоест, ако тази болница е представителна за останалите лечебни
  заведения в страната, ние бихме могли да сме по-уверени в заключението си
  какъв процент от болните от Алцхаймер живеят по-малко от 7 години. Иначе,
  бихме могли да си направим заключение само за нашата болница.

  И така, след като определихме тия въпроси, вече можем да решим задачата. За
  целта, първо трябва да изчислим приближението чрез нормално разпределение на
  средното на извадката:

                           mean(X) - mu
                      z = --------------
                           sd / sqrt(n)

  С X сме означили извадката от пациентите починали от Алцхаймер в тази
  болница. Чудим се каква е вероятността пациентите да живеят средно по-малко
  от 7 години. Тази вероятност отговаря на площта на стандартната нормална
  крива наляво от z, където z е оценката на извадъчното средно спрямо 
  популационното средно - директно приложение на ЦГТ. В случая,

                               7 - 8
                      z = -------------- = -1.37
                           4 / sqrt(30)
  
                P(mean(x) < 7) = P(z < -1.37) = 0.0853

  Тоест, вероятността пациент болен от Алцхаймер да живее по-малко от 7 години
  е 0.0853. Така, без точно да знаем какво е разпределението на пациентите
  болни от Алцхаймер, ние успяхме да си направим заключение за това каква е
  вероятността някой пациент да живее по-малко от 7 години.

  Друг начин, по който можем да разберем дали някакви данни са приблизително
  нормални е да начертаем тяхната квантил-квантил графика. Тази графика
  представя квантилите на нашите данни съпоставени с квантилите на
  нормалното разпределение. q-квантил е такава стойност, за която q*100% от
  данните са по-малки от нея. Например, медианата е 0.5-квантил, Q1 е 
  0.25-квантил, а Q3 е 0.75-квантил. Ако графиката, която сме начертали
  прилича на права линия, значи нашите данни са приблизително нормални.

    > x = rnorm(100, 0, 1); qqnorm(x)
    > x = rnorm(100, 10, 15); qqnorm(x)
    > x = rexp(100, 1/10); qqnorm(x)
    > x = runif(100, 0, 1); qqnorm(x)
